@model IEnumerable<Shusha_project_BackUp.Data.Waste_Sales>

@{
    ViewData["Title"] = "سجل مبيعات المخلفات";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    :root {
        --primary-color: #0d6efd;
        --success-color: #198754;
        --info-color: #0dcaf0;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --waste-color: #6c757d;
        --waste-light: #adb5bd;
    }

    .page-header {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
        padding: 2.5rem 0;
        margin-bottom: 2rem;
        border-radius: 1rem;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .page-header h1 {
        margin: 0;
        font-weight: 700;
        font-size: 2.5rem;
    }

    .page-header p {
        margin: 0.5rem 0 0 0;
        font-size: 1.1rem;
        opacity: 0.9;
    }

    .stats-card {
        transition: all 0.3s ease;
        border: none;
        border-radius: 1rem;
        overflow: hidden;
        height: 100%;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .stats-card .card-header {
        font-weight: 600;
        font-size: 1.1rem;
        padding: 1.25rem;
        border: none;
    }

    .stats-card .card-body {
        padding: 2rem 1.5rem;
    }

    .metric-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        border-left: 4px solid var(--waste-color);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        height: 100%;
    }

    .metric-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .metric-card.primary {
        border-left-color: var(--primary-color);
    }

    .metric-card.success {
        border-left-color: var(--success-color);
    }

    .metric-card.warning {
        border-left-color: var(--warning-color);
    }

    .metric-card .metric-icon {
        font-size: 2.5rem;
        opacity: 0.2;
        position: absolute;
        right: 1.5rem;
        top: 50%;
        transform: translateY(-50%);
    }

    .metric-card .metric-label {
        font-size: 0.95rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .metric-card .metric-value {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        position: relative;
        z-index: 1;
    }

    .filter-section {
        background: white;
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
    }

    .filter-section label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .btn-action {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .table-container {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        overflow-x: auto;
        max-height: 600px;
        overflow-y: auto;
        position: relative;
    }

    .table-container::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .table-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .table-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    .table-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    #wasteSalesTable {
        margin: 0;
        font-size: 0.95rem;
    }

    #wasteSalesTable thead th {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
        font-weight: 600;
        padding: 1rem 0.75rem;
        white-space: nowrap;
        border: none;
        position: sticky;
        top: 0;
        z-index: 10;
        text-align: center;
        vertical-align: middle;
    }

    #wasteSalesTable tbody td {
        padding: 1rem 0.75rem;
        vertical-align: middle;
        border-bottom: 1px solid #e9ecef;
        text-align: center;
    }

    #wasteSalesTable tbody tr {
        transition: background-color 0.2s ease;
    }

    #wasteSalesTable tbody tr:hover {
        background-color: #f8f9fa;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: nowrap;
        justify-content: center;
    }

    .action-buttons .btn {
        padding: 0.5rem;
        font-size: 1rem;
        border-radius: 0.4rem;
        transition: all 0.2s ease;
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .action-buttons .btn:hover {
        transform: scale(1.1);
    }

    .action-buttons .btn i {
        margin: 0;
    }

    .total-badge {
        background: linear-gradient(135deg, var(--success-color) 0%, #146c43 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 700;
        font-size: 1.1rem;
        display: inline-block;
    }

    @@media (max-width: 768px) {
        .page-header h1 {
            font-size: 1.75rem;
        }

        .metric-card .metric-value {
            font-size: 1.5rem;
        }
    }
</style>

<div class="page-header text-center">
    <h1>
        <i class="bi bi-recycle"></i>
        سجل مبيعات المخلفات
    </h1>
    <p>إدارة وتتبع مبيعات المخلفات والنفايات</p>
</div>

<!-- Today's Statistics -->
<div class="stats-card card shadow-sm mb-4">
    <div class="card-header text-white text-center" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
        <i class="bi bi-calendar-day"></i>
        إحصائيات اليوم
    </div>
    <div class="card-body">
        <div class="row g-3 text-center">
            <div class="col-md-4">
                <div class="p-3 bg-light rounded position-relative">
                    <i class="bi bi-rulers text-primary" style="font-size: 3rem; opacity: 0.1; position: absolute; right: 1rem; top: 50%; transform: translateY(-50%);"></i>
                    <h6 class="text-muted mb-2">إجمالي الأمتار اليوم</h6>
                    <h3 class="text-primary fw-bold mb-0">@ViewBag.TodayTotalMeters</h3>
                    <small class="text-muted">متر</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 bg-light rounded position-relative">
                    <i class="bi bi-currency-dollar text-success" style="font-size: 3rem; opacity: 0.1; position: absolute; right: 1rem; top: 50%; transform: translateY(-50%);"></i>
                    <h6 class="text-muted mb-2">إجمالي الإيرادات اليوم</h6>
                    <h3 class="text-success fw-bold mb-0">@ViewBag.TodayTotalRevenue.ToString("N2")</h3>
                    <small class="text-muted">جنيه</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 bg-light rounded position-relative">
                    <i class="bi bi-cart-check text-warning" style="font-size: 3rem; opacity: 0.1; position: absolute; right: 1rem; top: 50%; transform: translateY(-50%);"></i>
                    <h6 class="text-muted mb-2">عدد المعاملات اليوم</h6>
                    <h3 class="text-warning fw-bold mb-0">@ViewBag.TodayTransactions</h3>
                    <small class="text-muted">معاملة</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <a asp-action="Create" class="btn btn-primary btn-action">
        <i class="bi bi-plus-circle"></i>
        إضافة سجل جديد
    </a>
    <a asp-action="ExportToExcel"
       asp-route-from="@ViewBag.From"
       asp-route-to="@ViewBag.To"
       asp-route-month="@ViewBag.Month"
       class="btn btn-success btn-action">
        <i class="bi bi-file-earmark-excel"></i>
        تصدير إلى إكسل
    </a>
</div>

<!-- Filter Section -->
<div class="filter-section">
    <form asp-action="Index" method="get" class="row g-3 align-items-end">
        <div class="col-md-3">
            <label for="from" class="form-label">
                <i class="bi bi-calendar-range"></i>
                من تاريخ
            </label>
            <input type="date" id="from" name="from" value="@ViewBag.From" class="form-control" />
        </div>
        <div class="col-md-3">
            <label for="to" class="form-label">
                <i class="bi bi-calendar-range"></i>
                إلى تاريخ
            </label>
            <input type="date" id="to" name="to" value="@ViewBag.To" class="form-control" />
        </div>
        <div class="col-md-3">
            <label for="month" class="form-label">
                <i class="bi bi-calendar-month"></i>
                الشهر
            </label>
            <select id="month" name="month" class="form-select">
                <option value="">-- اختر الشهر --</option>
                @for (int i = 1; i <= 12; i++)
                {
                    <option value="@i" @@(ViewBag.Month == i ? "selected" : "")>
                        @System.Globalization.CultureInfo.GetCultureInfo("ar-EG").DateTimeFormat.GetMonthName(i)
                    </option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <button type="submit" class="btn btn-primary btn-action w-100">
                <i class="bi bi-search"></i>
                بحث
            </button>
        </div>
    </form>
</div>

<!-- Data Table -->
<div class="table-container">
    <table id="wasteSalesTable" class="table table-striped table-hover">
        <thead>
            <tr>
                <th><i class="bi bi-calendar-event"></i> التاريخ</th>
                <th><i class="bi bi-person-badge"></i> اسم التاجر</th>
                <th><i class="bi bi-rulers"></i> عدد الأمتار</th>
                <th><i class="bi bi-currency-dollar"></i> السعر للمتر</th>
                <th><i class="bi bi-cash-stack"></i> الإجمالي</th>
                <th><i class="bi bi-gear"></i> إجراءات</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.date.ToString("yyyy-MM-dd")</td>
                    <td><strong>@(item.TraderName ?? "غير محدد")</strong></td>
                    <td>
                        <span class="badge bg-primary">@item.wasteMeters متر</span>
                    </td>
                    <td>@item.price.ToString("N2") جنيه</td>
                    <td>
                        <span class="total-badge">@((item.wasteMeters * item.price).ToString("N2")) جنيه</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-warning btn-sm" title="تعديل" data-bs-toggle="tooltip">
                                <i class="bi bi-pencil-square"></i>
                            </a>
                            <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-info btn-sm" title="تفاصيل" data-bs-toggle="tooltip">
                                <i class="bi bi-info-circle"></i>
                            </a>
                            <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-danger btn-sm" title="حذف" data-bs-toggle="tooltip">
                                <i class="bi bi-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Overall Statistics -->
<div class="container mt-4">
    <div class="row g-3">
        <div class="col-md-3">
            <div class="metric-card primary">
                <i class="bi bi-rulers metric-icon text-primary"></i>
                <div class="metric-label">إجمالي الأمتار</div>
                <div class="metric-value text-primary">@ViewBag.TotalMeters</div>
                <small class="text-muted">متر</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card success">
                <i class="bi bi-currency-dollar metric-icon text-success"></i>
                <div class="metric-label">إجمالي الإيرادات</div>
                <div class="metric-value text-success">@ViewBag.TotalRevenue.ToString("N2")</div>
                <small class="text-muted">جنيه</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card warning">
                <i class="bi bi-calculator metric-icon text-warning"></i>
                <div class="metric-label">متوسط السعر</div>
                <div class="metric-value text-warning">@ViewBag.AveragePrice.ToString("N2")</div>
                <small class="text-muted">جنيه/متر</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <i class="bi bi-cart-check metric-icon" style="color: var(--waste-color);"></i>
                <div class="metric-label">عدد المعاملات</div>
                <div class="metric-value" style="color: var(--waste-color);">@ViewBag.TotalTransactions</div>
                <small class="text-muted">معاملة</small>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.1/css/dataTables.bootstrap5.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.1/js/dataTables.bootstrap5.min.js"></script>
    <script>
        $(document).ready(function() {
            // Initialize DataTables
            $('#wasteSalesTable').DataTable({
                "language": {
                    "url": "https://cdn.datatables.net/plug-ins/1.13.1/i18n/ar.json",
                    "emptyTable": "لا توجد بيانات لعرضها",
                    "paginate": {
                        "first": "الأول",
                        "last": "الآخر",
                        "next": "التالي",
                        "previous": "السابق"
                    },
                    "info": "عرض _START_ إلى _END_ من _TOTAL_ سجل",
                    "infoEmpty": "لا توجد بيانات لعرضها",
                    "infoFiltered": "(تم تصفيتها من _MAX_ إجمالي العناصر)",
                    "search": "بحث:",
                    "lengthMenu": "عرض _MENU_ سجل"
                },
                "pagingType": "full_numbers",
                "responsive": true,
                "ordering": true,
                "pageLength": 25,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "الكل"]],
                "order": [[0, "desc"]], // Sort by date descending
                "scrollY": false,
                "scrollCollapse": false
            });

            // Initialize Bootstrap tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
}

